"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var _slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,l=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(u){a=!0,l=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw l}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),P4DEFS={STORAGE_NAME_PREFIX:"nabudis.p4g_fusion.",STORAGE_DOUBLE_RECIPES:"double_recipes",STORAGE_TRIPLE_RECIPES:"triple_recipes",PERSONAS:"personas",SKILLS_BY_CATEGORY:"skillsByCategory",ARCANAS:new Map};$(function(){var e=$("#mainMenu .menubutton");e.click(function(){$(this).addClass("selected"),e.not(this).removeClass("selected")})});var p4gData=function(){function e(){return Array.from(P4DEFS.ARCANAS.keys())}function t(e){return e?R.getCollection(P4DEFS.PERSONAS).find({name:e})[0]:null}function r(e){if(k||(k=R.getCollection(P4DEFS.PERSONAS).chain().find({arcana:{$ne:"World"}}).sort(l).data()),e){var r=k.slice();return r.push(t("Izanagi-no-Okami")),r.sort(l),r}return k}function n(){if(!L){var e=R.getCollection(P4DEFS.SKILLS_BY_CATEGORY).find();L=_.flatten(e.map(function(e){return e.skills}))}return L}function a(e){switch(e){case"NORMAL":return"---";case"WEAK":return"Wk";case"RESIST":return"Str";case"BLOCK":return"Nul";case"ABSORB":return"Dr";case"REFLECT":return"Rpl"}}function l(e,t){return e.name>t.name?1:e.name<t.name?-1:0}function i(e,t){return e.currentLevel-t.currentLevel||e.level-t.level}function o(e,t){return P4DEFS.ARCANAS.get(e.arcana)-P4DEFS.ARCANAS.get(t.arcana)}function u(e,t,r){var n=P4DEFS.ARCANAS.get(e),a=P4DEFS.ARCANAS.get(t);return r?b[Math.max(n,a)][Math.min(n,a)]:b[Math.min(n,a)][Math.max(n,a)]}function c(e,t){if(e.name===t.name)return null;var r=u(e.arcana,t.arcana,!1);return r?s(e,t,r):null}function s(e,t,r){var n=Math.floor(1+(e.level+t.level)/2),a=R.getCollection(P4DEFS.PERSONAS).chain().find({arcana:r});return e.arcana!==t.arcana?a.find({level:{$gte:n}}).sort(i):a.find({level:{$lte:n}}).where(function(r){return r.name!==e.name&&r.name!==t.name&&!r.special}).sort(_.negate(i)),a.data()[0]}function f(e,t,r){if(e.name===t.name||e.name===r.name||t.name===r.name)return null;var n=[e,t,r].sort(function(e,t){return i(e,t)||-o(e,t)}),a=_slicedToArray(n,3);e=a[0],t=a[1],r=a[2];var l=u(e.arcana,t.arcana,!1);if(!l)return null;var c=u(l,r.arcana,!0);return v(e,t,r,c)}function v(e,t,r,n){var a=Math.floor(5+(e.level+t.level+r.level)/3);return R.getCollection(P4DEFS.PERSONAS).chain().find({arcana:n}).find({level:{$gte:a}}).where(function(n){return n.name!==e.name&&n.name!==t.name&&n.name!==r.name&&!n.special}).sort(i).data()[0]}function d(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];t=_.compact(t);var n=!0,a=!1,i=void 0;try{for(var o,u=P.entries()[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var c=o.value,s=c[1];if(t.length===s.length&&t.length===_.intersectionWith(t,s,l))return c.key}}catch(f){a=!0,i=f}finally{try{!n&&u["return"]&&u["return"]()}finally{if(a)throw i}}return null}function y(){function e(e,r){var n=!0,a=!1,l=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var c=i.value;e.set(c,[])}}catch(s){a=!0,l=s}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw l}}for(var f=0;f<t.length;f++)for(var v=f;v<t.length;v++){var d=u(t[f],t[v],r);d&&(e.get(d).push([t[f],t[v]]),r&&e.get(d).push([t[v],t[f]]))}}var t=Array.from(P4DEFS.ARCANAS.keys());e(w,!1),e(x,!0)}function g(e){var t=new Map,r=!0,n=!1,a=void 0;try{for(var l,i=e[Symbol.iterator]();!(r=(l=i.next()).done);r=!0){var o=l.value;t.has(o.arcana)||t.set(o.arcana,[]),t.get(o.arcana).push(o)}}catch(u){n=!0,a=u}finally{try{!r&&i["return"]&&i["return"]()}finally{if(n)throw a}}return t}function m(e){return e&&e.length>0?e.map(t):r()}function h(e,t){var r=m(t),n=g(r),a=[],l=!0,i=!1,o=void 0;try{for(var u,c=w.get(e.arcana)[Symbol.iterator]();!(l=(u=c.next()).done);l=!0){var f=u.value;if(n.has(f[0])&&n.has(f[1])){var v=!0,d=!1,y=void 0;try{for(var h,p=n.get(f[0])[Symbol.iterator]();!(v=(h=p.next()).done);v=!0){var S=h.value,A=!0,E=!1,C=void 0;try{for(var R,b=n.get(f[1])[Symbol.iterator]();!(A=(R=b.next()).done);A=!0){var P=R.value;if(S.arcana!==P.arcana||P.level>S.level){var x=s(S,P,e.arcana);x&&e.name===x.name&&a.push([S,P])}}}catch(D){E=!0,C=D}finally{try{!A&&b["return"]&&b["return"]()}finally{if(E)throw C}}}}catch(D){d=!0,y=D}finally{try{!v&&p["return"]&&p["return"]()}finally{if(d)throw y}}}}}catch(D){i=!0,o=D}finally{try{!l&&c["return"]&&c["return"]()}finally{if(i)throw o}}return a}function p(e){function t(e,t,r){return r.level<e.level||r.level<t.level?!1:r.level===e.level&&o(r,e)>=0?!1:r.level===t.level&&o(r,t)>=0?!1:!0}var r=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=m(r),a=g(n),l=[],i=!0,u=!1,c=void 0;try{for(var s,f=x.get(e.arcana)[Symbol.iterator]();!(i=(s=f.next()).done);i=!0){var d=s.value,y=!0,h=!1,p=void 0;try{for(var S,A=w.get(d[0])[Symbol.iterator]();!(y=(S=A.next()).done);y=!0){var E=S.value,C=[].concat(_toConsumableArray(E),[d[1]]);if(a.has(C[0])&&a.has(C[1])&&a.has(C[2])){var R=!0,b=!1,P=void 0;try{for(var D,N=a.get(C[0])[Symbol.iterator]();!(R=(D=N.next()).done);R=!0){var k=D.value,L=!0,_=!1,T=void 0;try{for(var F,B=a.get(C[1])[Symbol.iterator]();!(L=(F=B.next()).done);L=!0){var O=F.value;if(k.arcana!==O.arcana||O.level>k.level){var $=!0,M=!1,I=void 0;try{for(var V,q=a.get(C[2])[Symbol.iterator]();!($=(V=q.next()).done);$=!0){var G=V.value;if(t(k,O,G)){var Y=v(k,O,G,e.arcana);Y&&e.name===Y.name&&l.push([k,O,G])}}}catch(K){M=!0,I=K}finally{try{!$&&q["return"]&&q["return"]()}finally{if(M)throw I}}}}}catch(K){_=!0,T=K}finally{try{!L&&B["return"]&&B["return"]()}finally{if(_)throw T}}}}catch(K){b=!0,P=K}finally{try{!R&&N["return"]&&N["return"]()}finally{if(b)throw P}}}}}catch(K){h=!0,p=K}finally{try{!y&&A["return"]&&A["return"]()}finally{if(h)throw p}}}}catch(K){u=!0,c=K}finally{try{!i&&f["return"]&&f["return"]()}finally{if(u)throw c}}return l}function S(e){return P.has(e.name)?P.get(e.name).map(t):null}var A="p4g.json",E="main_fusion_table.csv",C="special_fusion_recipes.csv",R=new loki("p4db"),b=void 0,P=void 0,w=new Map,x=new Map,D=$.getJSON(A,function(e){console.assert(e.hasOwnProperty(P4DEFS.PERSONAS)),console.assert(e.hasOwnProperty(P4DEFS.SKILLS_BY_CATEGORY)),Object.keys(e).forEach(function(t){R.addCollection(t).insert(e[t])});R.getCollection(P4DEFS.PERSONAS)}),N=$.get(E,function(e){b=$.csv.toArrays(e);for(var t=b[0],r=1;r<t.length;r++)P4DEFS.ARCANAS.set(t[r],r)});return P=new Map,$.get(C,function(e){$.csv.toArrays(e).forEach(function(e){return P.set(e[0],e.slice(1))})}),$.when(D,N).then(y),{getAllArcanas:e,getPersonaByName:t,getAllPersonas:r,getAllSkills:n,getResValText:a,getDoubleFusionResult:c,getDoubleFusionRecipes:h,getTripleFusionResult:f,getTripleFusionRecipes:p,getSpecialFusionResult:d,getSpecialFusionRecipe:S};var k,L}(),guiUtils=function(){function e(e,t){var r=document.importNode(document.querySelector("#personaDetailsTemplate").content,!0);e.appendChild(r);var n=e.querySelector(".personaDetails");return $(n).find(".personaBanner").click(function(){"true"===n.getAttribute(l)&&$(n).find(".personaBreakdown").toggleClass("hidden")}),n.setAttribute(a,t?"true":"false"),n}function t(e,t){if(!t||!t.level){var n=t?t.name:"";return e.querySelector(".personaLegend").textContent=n,$(e.querySelector(".personaBreakdown")).addClass("hidden"),void e.setAttribute(l,"false")}e.setAttribute(l,"true"),"true"===e.getAttribute(a)?e.querySelector(".personaLegend").textContent="( L"+t.level+" "+t.arcana+" )":e.querySelector(".personaLegend").textContent=t.name+" ( L"+t.level+" "+t.arcana+" )",e.getElementsByClassName("phys")[0].textContent=p4gData.getResValText(t.physical),e.getElementsByClassName("fire")[0].textContent=p4gData.getResValText(t.fire),e.getElementsByClassName("ice")[0].textContent=p4gData.getResValText(t.ice),e.getElementsByClassName("elec")[0].textContent=p4gData.getResValText(t.electricity),e.getElementsByClassName("wind")[0].textContent=p4gData.getResValText(t.wind),e.getElementsByClassName("light")[0].textContent=p4gData.getResValText(t.light),e.getElementsByClassName("dark")[0].textContent=p4gData.getResValText(t.dark);var i=2,o="data-skillName",u=0,c="",s=t.learnedSkills.sort(function(e,t){return e.levelLearned-t.levelLearned}),f=!0,v=!1,d=void 0;try{for(var y,g=t.defaultSkills.concat(s)[Symbol.iterator]();!(f=(y=g.next()).done);f=!0){var m=y.value;u%i===0&&(c+="<tr>");var h=m.levelLearned>0?" (L"+m.levelLearned+")":"";c+="<td><button "+o+'="'+m.skillName+'">'+m.skillName+h+"</button></td>",u%i===i-1&&(c+="</tr>"),u++}}catch(p){v=!0,d=p}finally{try{!f&&g["return"]&&g["return"]()}finally{if(v)throw d}}e.getElementsByClassName("skills")[0].innerHTML=c,$(e).find(".skills button").click(function(e){return r(e.target.getAttribute(o))})}function r(e){function t(e){if(n[e]){var t=_.capitalize(e);a+="<tr><td>"+t+":</td><td>"+n[e]+"</td></tr>"}}var r=document.createElement("div"),n=p4gData.getAllSkills().find(function(t){return t.name===e}),a="<table>";a+='<tr><td colspan="2">'+n.description+"</td></tr>",t("acquisition"),t("power"),t("critical"),t("accuracy"),t("cost"),a+="</table>",r.innerHTML=a,$(r).dialog({dialogClass:"popup",modal:!0,resizable:!1,title:e}),$(r).click(function(){return $(r).dialog("destroy")})}function n(e,t,r){var n=parent.guiUtils.initPersonaInfoView(e,!0),a=e.querySelector(".personaSelect");a.appendChild(document.createElement("option"));var l=p4gData.getAllPersonas(r),i=!0,o=!1,u=void 0;try{for(var c,s=l[Symbol.iterator]();!(i=(c=s.next()).done);i=!0){var f=c.value,v=document.createElement("option");v.textContent=f.name,a.appendChild(v)}}catch(d){o=!0,u=d}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw u}}a.addEventListener("change",function(e){var r=e.target.value,a=r?p4gData.getPersonaByName(r):null;guiUtils.displayPersona(n,a),t&&t(a)}),a.addEventListener("click",function(e){return e.stopPropagation()}),$(a).removeClass("hidden")}var a="data-allowselection",l="data-isvalid";return{initPersonaInfoView:e,displayPersona:t,populatePersonaList:n}}();$(function(){return document.getElementById("fusionMenuButton").click()});